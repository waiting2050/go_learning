# SQL 笔记：计算首次订单中即时订单比例
## 1. 需求分析
- 首次订单：每个用户最早下单的订单（1个用户仅1个）
- 即时订单：下单日期（order_date）= 期望配送日期（customer_pref_delivery_date）
- 目标：计算即时订单在所有首次订单中的占比（保留2位小数）


## 2. 核心思路
1. **子查询筛选首次订单**：按 `customer_id` 分组，取 `min(order_date)` 得到每个用户的首次订单信息
2. **主查询计算占比**：
   - 用 `sum(order_date = 期望日期)` 统计首次订单中的即时订单数（满足条件返回1，否则0，求和即数量）
   - 用 `count(*)` 统计首次订单总数
   - 计算占比（×100）并四舍五入


## 3. 完整代码
```sql
SELECT 
  ROUND(
    SUM(order_date = customer_pref_delivery_date) * 100 / COUNT(*), 
    2
  ) AS immediate_percentage 
FROM Delivery 
WHERE (customer_id, order_date) IN (
  -- 子查询：获取每个用户的首次订单（用户ID + 最早下单日期）
  SELECT customer_id, MIN(order_date) 
  FROM Delivery 
  GROUP BY customer_id
);
```


## 4. 关键知识点
| 语法/逻辑                | 作用                                  |
|--------------------------|---------------------------------------|
| `MIN(order_date)`        | 按用户分组，取最早下单日期（定位首次订单） |
| `(A,B) IN (子查询)`      | 多列匹配，筛选出所有首次订单行          |
| `SUM(条件)`              | 统计满足条件的行数（条件为真返回1，求和即数量） |
| `ROUND(...,2)`           | 结果四舍五入保留2位小数                |
