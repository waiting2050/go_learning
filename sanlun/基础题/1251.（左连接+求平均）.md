# SQL 笔记：计算产品平均售价
## 1. 需求分析
- 关联两张表，按产品 ID 计算平均售价
- 平均售价 = （价格×销量总和）/ 销量总和，结果四舍五入保留 2 位小数
- 无销量的产品，平均售价设为 0


## 2. 核心思路
1. **表关联**：用 `LEFT JOIN` 关联 `Prices`（价格表）和 `UnitsSold`（销量表），确保无销量产品不被过滤
2. **时间匹配**：通过 `BETWEEN` 筛选出销量日期在价格有效期内的数据（`BETWEEN` 为前闭后闭，包含起止日期）
3. **聚合计算**：按 `product_id` 分组，用 `SUM` 计算总价和总销量，`IFNULL` 处理无销量场景


## 3. 完整代码
```sql
SELECT 
  p.product_id, 
  IFNULL(ROUND(SUM(p.price * u.units) / SUM(u.units), 2), 0) AS average_price 
FROM Prices p 
LEFT JOIN UnitsSold u 
  ON p.product_id = u.product_id 
  AND u.purchase_date BETWEEN p.start_date AND p.end_date  -- 匹配价格有效期
GROUP BY p.product_id;
```


## 4. 关键知识点
| 语法          | 作用                                  |
|---------------|---------------------------------------|
| `LEFT JOIN`   | 保留左表（Prices）所有产品，包括无销量的 |
| `BETWEEN A AND B` | 筛选日期在 [A,B] 区间内的数据        |
| `IFNULL(X,0)` | 若 X 为 NULL（无销量），则返回 0       |
| `ROUND(X,2)`  | 将 X 四舍五入保留 2 位小数             |
